<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wisdom Volatility Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 32px; max-width: 900px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 16px; }
    .score { font-size: 48px; font-weight: 800; margin: 0; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 14px; }
    pre { background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 10px; overflow: auto; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { color: #6b7280; }
    .section-title { font-weight: 700; margin: 0 0 6px 0; }
    .subtle { color: #6b7280; font-size: 14px; margin: 0 0 6px 0; }
  </style>
</head>
<body>
  <h1>Wisdom Volatility Scanner</h1>
  <p class="muted">Enter weekly incomes (one number per line). Example: 450 ↵ 620 ↵ 0 ↵ 710</p>

  <div class="row" style="align-items:flex-start;">
    <textarea id="incomeText" rows="6" style="width:520px; padding:10px; border-radius:10px; border:1px solid #e5e7eb;"
      placeholder="450
  620
  0
  710"></textarea>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button id="analyzeBtn">Analyze</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div id="result" class="card" style="display:none;">
    <div class="row" style="justify-content: space-between;">
      <div>
        <p class="muted" style="margin:0;">Volatility score</p>
        <p class="score" id="score">—</p>
        <span class="pill" id="band">—</span>
      </div>

      <div style="min-width: 280px;">
        <p class="muted" style="margin:0 0 6px 0;">Key metrics</p>
        <ul style="margin:0; padding-left: 18px;">
          <li><span class="muted">Mean:</span> <span id="mean">—</span></li>
          <li><span class="muted">Std:</span> <span id="std">—</span></li>
          <li><span class="muted">CV:</span> <span id="cv">—</span></li>
          <li><span class="muted">Gap rate:</span> <span id="gap">—</span></li>
          <li><span class="muted">Max drawdown:</span> <span id="dd">—</span></li>
        </ul>
      </div>
    </div>

    <!-- AI Insights -->
    <div id="aiInsights" style="margin-top:16px; display:none;">
      <p class="section-title">AI insights</p>

      <div style="display:flex; gap:24px; flex-wrap:wrap;">
        <div style="min-width: 240px;">
          <p class="subtle">Signals</p>
          <ul id="signalsList" style="margin:0; padding-left: 18px;"></ul>
        </div>

        <div style="flex:1; min-width: 280px;">
          <p class="subtle">Explanation</p>
          <p id="explanationText" style="margin:0; line-height:1.45;"></p>

          <p class="subtle" style="margin-top: 14px;">Safe next steps</p>
          <ul id="nextStepsList" style="margin:0; padding-left: 18px;"></ul>
        </div>
      </div>
    </div>

    <details style="margin-top: 12px;">
      <summary>Raw JSON</summary>
      <pre id="raw"></pre>
    </details>
  </div>

  <script>
    const API_BASE = ""; // same-origin on Render

    const incomeText = document.getElementById("incomeText");
    const btn = document.getElementById("analyzeBtn");
    const statusEl = document.getElementById("status");

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg;
    }

    function textToCsv(text) {
      // one number per line -> CSV with header "amount"
      const lines = text
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);

      // validate numeric
      const nums = [];
      for (const line of lines) {
        const n = Number(line);
        if (!Number.isFinite(n)) {
          throw new Error(`Not a number: "${line}"`);
        }
        nums.push(n);
      }

      if (nums.length < 4) {
        throw new Error("Enter at least 4 weekly income values.");
      }

      return "amount\n" + nums.join("\n") + "\n";
    }

    btn.addEventListener("click", async () => {
      try {
        setStatus("Analyzing...");

        const csv = textToCsv(incomeText.value);

        // make a fake CSV "file" so your existing backend /analyze works unchanged
        const blob = new Blob([csv], { type: "text/csv" });
        const file = new File([blob], "income_weekly.csv", { type: "text/csv" });

        const formData = new FormData();
        formData.append("file", file);

        // optional: user_id (if you wired it)
        const userIdEl = document.getElementById("userId");
        if (userIdEl && userIdEl.value.trim()) {
          formData.append("user_id", userIdEl.value.trim());
        }

        const res = await fetch(`${API_BASE}/analyze`, {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data?.detail || "Request failed");
        }

        // TODO: render results into your page (wherever you show score/metrics)
        console.log("API response:", data);
        setStatus("Done.");

        // If you already have a function that renders results, call it here:
        // renderResult(data);

      } catch (err) {
        console.error(err);
        setStatus(err.message || "Error");
        alert(err.message || "Error");
      }
    });
  </script>

</body>
</html>
